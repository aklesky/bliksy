# Vite React Server Side Plugin

A Plugin for Vite to enable Server Side Rendering for React with Pipeable Stream.

- [Vite React Server Side Plugin](#vite-react-server-side-plugin)
  - [Installation](#installation)
  - [Usage](#usage)
  - [Configuration Parameters](#configuration-parameters)
    - [*entry*](#entry)
    - [*enableDoctypeHeader*](#enabledoctypeheader)
    - [*ignoreUrlExpressions*](#ignoreurlexpressions)
    - [*title*](#title)
    - [*nonce*](#nonce)
    - [*identifierPrefix*](#identifierprefix)
    - [*progressiveChunkSize*](#progressivechunksize)
    - [*namespaceURI*](#namespaceuri)
    - [*bootstrapScripts*](#bootstrapscripts)
    - [*bootstrapModules*](#bootstrapmodules)
    - [*enableTimeout*](#enabletimeout)
    - [*timeout*](#timeout)
    - [*addClosingHtmlBodyTag*](#addclosinghtmlbodytag)
  - [Event Handlers](#event-handlers)
    - [*onAllReadyHandler*](#onallreadyhandler)
    - [*onShellReadyHandler*](#onshellreadyhandler)
    - [*onShellErrorHandler*](#onshellerrorhandler)
    - [*onErrorHandler*](#onerrorhandler)
    - [*onFinishEventHandler*](#onfinisheventhandler)
    - [*onTimeoutHandler*](#ontimeouthandler)

## Installation

npm

```shell
npm install -D @aklesky/vite-react-ssr-plugin
```

yarn

```shell
yarn add -D @aklesky/vite-react-ssr-plugin
```

## Usage

```typescript
import plugin from '@aklesky/@aklesky/vite-react-ssr-plugin/plugin.js'
import { defineConfig } from 'vite'

export default defineConfig({
    // ...
    root: "src",
    plugins: [plugin({
        entry: './entries/server.tsx',
        bootstrapModules: ['./entries/client.tsx'],
    })],
    // ...
  }
)

```

## Configuration Parameters

### *entry*

An entry point for loading a React component on a server via ssrLoadModule

[More about ssrLoadModule](https://vitejs.dev/guide/api-javascript.html#vitedevserver)

```typescript
    entry: string
```

### *enableDoctypeHeader*

Enable or disable the doctype header to be added to the stream.

> *`Enabled`* by default

```typescript
    enableDoctypeHeader?: boolean

    // ...
    if (options.enableDoctypeHeader) {
        http.ServerResponse.write('<!DOCTYPE html>')
    }
```

### *ignoreUrlExpressions*

An array of regular expressions to ignore the certain urls.

> ***By `default`, this will exclude any URLs with file extensions and URLs starting with "/@...".***
>
> `uri.pathname = '/@vite/client'`
>
> *`default`* `[/\.([^.]*?)(?=\?|#|$)/, /\/@[.]*?/]`

```typescript
    ignoreUrlExpressions?: RegExp[]
```

### *title*

An Html Title to be added to the stream.

> *`default`*: `Vite.js React Server Side Plugin`

```typescript
    title?: string
```

### *nonce*

A nonce string to allow scripts for script-src Content-Security-Policy.

```typescript
    nonce?: string
```

- [Read more about the nonce parameter.](https://beta.reactjs.org/reference/react-dom/server/renderToPipeableStream#parameters)
- [Read more about the Content-Security-Policy.](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src)

### *identifierPrefix*

A string prefix React uses for IDs generated by useId.

```typescript
    identifierPrefix?: string
```

- [Read more about the identifierPrefix parameter](https://beta.reactjs.org/reference/react-dom/server/renderToPipeableStream#parameters)

### *progressiveChunkSize*

The number of bytes in a chunk.

```typescript
    progressiveChunkSize?: number
```

- [Read more about the default heuristic.](https://github.com/facebook/react/blob/14c2be8dac2d5482fda8a0906a31d239df8551fc/packages/react-server/src/ReactFizzServer.js#L210-L225)

> *`default`* 12800

### *namespaceURI*

A string with the root namespace URI for the stream. Defaults to regular HTML.

```typescript
    namespaceURI?: string
```

[Read more about the namespaceURI parameter](https://beta.reactjs.org/reference/react-dom/server/renderToPipeableStream#parameters)

### *bootstrapScripts*

An array of string URLs for the \<script\> tags to emit on the page.
Use this to include the \<script type="module\"\> that calls hydrateRoot.

 ```typescript
    bootstrapScripts?: string[]
```

[Read more about the bootstrapScripts](https://beta.reactjs.org/reference/react-dom/server/renderToPipeableStream#parameters)

### *bootstrapModules*

An array of string URLs for the \<script type="module"\> tags to emit on the page.

```typescript
    bootstrapModules?: string[]
```

[Read more about the bootstrapModules](https://beta.reactjs.org/reference/react-dom/server/renderToPipeableStream#parameters)

### *enableTimeout*

Enable the server rendering to “give up” after a timeout

> *`default`* false

```typescript
    enableTimeout?: boolean
```

### *timeout*

Force the server rendering to “give up” after a timeout

```typescript
    timeout?: number
```

> *`default`* 10000 ms

- [Read more about aborting server rendering](https://beta.reactjs.org/reference/react-dom/server/renderToPipeableStream#aborting-server-rendering )

### *addClosingHtmlBodyTag*

Write closing body and html tags to the end of the stream and end it.

```typescript
    addClosingHtmlBodyTag?: boolean
```

> default true
>
> ***`Writable.end('\<\/body>\<\/html\>')`***

## Event Handlers

`These event handler functions primarily focus on receiving two arguments and return a callback function that takes in additional arguments.`

[Learn more about the callback function that takes in additional arguments.](https://github.com/aklesky/node-workspace/blob/next/packages/streamable-react/wiki/streamable.md)

### *onAllReadyHandler*

```typescript
    onAllReadyHandler?: (req: http.IncomingMessage, res: http.ServerResponse) => (pipe: () => Writable, error?: Error) => Promise<void>
```

### *onShellReadyHandler*

```typescript
    onShellReadyHandler?: (req: http.IncomingMessage, res: http.ServerResponse) => (pipe: () => Writable, error?: Error) => Promise<void>
```

### *onShellErrorHandler*

```typescript
    onShellErrorHandler?: (req: http.IncomingMessage, res: http.ServerResponse) => (error: unknown, writeable: Writable) => Promise<void>
```

### *onErrorHandler*

```typescript
    onErrorHandler?: (req: http.IncomingMessage, res: http.ServerResponse) => (error: unknown, writeable: Writable) => Promise<void>
```

### *onFinishEventHandler*

```typescript
    onFinishEventHandler?: (req: http.IncomingMessage, res: http.ServerResponse) => () => Promise<string | void>
```

### *onTimeoutHandler*

```typescript
    onTimeoutHandler?: (req: http.IncomingMessage, res: http.ServerResponse) => (cb?: () => void) => Promise<void>
```
